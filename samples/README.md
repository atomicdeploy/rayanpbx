# RayanPBX Sample Configurations

This directory contains sample Asterisk configurations generated by RayanPBX, along with comprehensive analysis and comparison documentation.

## Files

### Configuration Samples
- **`pjsip.conf.sample`** - Complete PJSIP endpoint and trunk configurations
- **`extensions.conf.sample`** - Dialplan routing for incoming and outgoing calls

### Documentation
- **`CONFIG_COMPARISON.md`** - Detailed comparison between user-provided configs and RayanPBX auto-generated configs, with analysis of correctness and recommendations

## What's Included

### PJSIP Configuration (`pjsip.conf.sample`)
- ✅ Extension endpoints (100, 101) with full configuration
- ✅ Trunk configurations (PrimaryTrunk, Shatel)
- ✅ Transport definitions (UDP/TCP)
- ✅ All improvements from analysis:
  - `direct_media=no` for NAT compatibility
  - `from_domain` for provider requirements
  - `qualify_frequency` for health monitoring
  - `remove_existing` for clean registrations
  - Voicemail integration
  - HD codec support

### Dialplan Configuration (`extensions.conf.sample`)
- ✅ Internal extension dialing
- ✅ Outbound routing with prefix stripping
- ✅ Incoming call routing with DID mapping
- ✅ Voicemail fallback
- ✅ Caller ID preservation
- ✅ Section-based organization for safe updates

## How RayanPBX Generates These

### Via API

**Create Extension:**
```bash
curl -X POST http://localhost:8000/api/extensions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "extension_number": "100",
    "name": "John Doe",
    "secret": "secure_password",
    "context": "from-internal",
    "voicemail_enabled": true
  }'
```

**Create Trunk:**
```bash
curl -X POST http://localhost:8000/api/trunks \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "shatel-endpoint",
    "host": "tel07.fp.shatel.ir",
    "port": 5060,
    "context": "from-shatel",
    "prefix": "0",
    "strip_digits": 0,
    "from_domain": "tel07.fp.shatel.ir",
    "language": "en",
    "codecs": ["alaw"]
  }'
```

### Validation APIs

**Validate Extension Registration:**
```bash
curl http://localhost:8000/api/validate/extension/100 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Validate Trunk Connection:**
```bash
curl http://localhost:8000/api/validate/trunk/shatel-endpoint \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Test Call Routing:**
```bash
curl -X POST http://localhost:8000/api/validate/routing \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "from": "100",
    "to": "02191002369"
  }'
```

## Key Features

### Section-Based Configuration Management
RayanPBX uses proper INI section manipulation for configuration management:
```ini
[100]
type=endpoint
context=from-internal
...

[100]
type=auth
...

[100]
type=aor
...
```

This ensures:
- ✅ Safe automated updates via section name and type identification
- ✅ Manual configurations in separate sections are preserved
- ✅ Easy identification of sections by their [name] and type= property
- ✅ Standard Asterisk configuration format

### Configuration Analysis

The `CONFIG_COMPARISON.md` file provides:
- Detailed comparison with user-provided configurations
- Identification of correct/incorrect patterns
- Recommendations for improvements
- Validation of RayanPBX auto-generation logic

## Using These Samples

### Testing
These configurations can be used directly for testing:

```bash
# Copy to Asterisk config directory
sudo cp pjsip.conf.sample /etc/asterisk/pjsip.conf
sudo cp extensions.conf.sample /etc/asterisk/extensions.conf

# Update passwords and IPs as needed
sudo nano /etc/asterisk/pjsip.conf

# Reload Asterisk
sudo asterisk -rx "pjsip reload"
sudo asterisk -rx "dialplan reload"
```

### Customization
You can add your own sections alongside RayanPBX-managed sections:

```ini
; Your custom endpoint (RayanPBX won't touch sections it doesn't manage)
[custom-endpoint]
type=endpoint
...

; RayanPBX-managed extension (identified by section name)
[100]
type=endpoint
...
```

## Integration with PJSIP Service

RayanPBX provides APIs to interact with PJSIP:

- **Registration Validation** - Check if extensions are registered
- **Trunk Status** - Monitor trunk reachability and latency
- **Call Routing Tests** - Verify dialplan routing
- **GrandStream Hooks** - Automatic phone provisioning
- **Configuration Validation** - Syntax and correctness checks

See `CONFIG_COMPARISON.md` for detailed API documentation.

## Support

For issues or questions:
- Check `CONFIG_COMPARISON.md` for configuration analysis
- Review issue #1 for project requirements
- Test with validation APIs before deployment
- Use health check scripts: `scripts/health-check.sh`

## Version

These samples are generated by **RayanPBX Asterisk Adapter v2.0** with all improvements from configuration analysis.
